<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TaskBridge - æœˆæ¬¡ä½œæ¥­å ±å‘Šãƒ„ãƒ¼ãƒ«</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='taskbridge-logo.png') }}" />
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='taskbridge-logo.svg') }}" />
  <link rel="shortcut icon" href="{{ url_for('static', filename='taskbridge-logo.png') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>

<body>
  <!-- ===== ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ===== -->
  <div id="auth-box" style="max-width: 520px; margin: 40px auto;">
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="{{ url_for('static', filename='taskbridge-logo.png') }}" alt="TaskBridge Logo" style="width: 200px; height: 200px; margin-bottom: 10px;">
      <h1 style="color: #5fa8a8; margin: 10px 0;">TaskBridge</h1>
    </div>
    <h2 style="margin-bottom: 10px;">ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <input
        id="login-email"
        type="email"
        placeholder="Email"
        style="
          width: 100%;
          padding: 10px;
          margin: 6px 0;
          border: 1px solid #ddd;
          border-radius: 8px;
        "
      />
      <input
        id="login-password"
        type="password"
        placeholder="Password"
        style="
          width: 100%;
          padding: 10px;
          margin: 6px 0;
          border: 1px solid #ddd;
          border-radius: 8px;
        "
      />
      <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px">
        <button class="btn btn-primary btn-small" onclick="loginWithEmail()">
          ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³
        </button>
        <button class="btn btn-success btn-small" onclick="signupWithEmail()">
          æ–°è¦ç™»éŒ²ï¼ˆãƒ¡ãƒ¼ãƒ«ï¼‰
        </button>
        <button class="btn btn-warning btn-small" onclick="loginWithGoogle()">
          Googleã§ãƒ­ã‚°ã‚¤ãƒ³
        </button>
      </div>
      <p id="auth-error" style="color: #d00; margin-top: 10px"></p>
    </div>

    <!-- ===== ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª ===== -->
    <div id="app-box" style="display: none">
      <div style="text-align: right; max-width: 1200px; margin: 10px auto 0">
        ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <span id="auth-user"></span>
        <button class="btn btn-danger btn-small" onclick="logout()">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>

      <div class="container">
        <div class="header">
          <h1>ğŸ“Š æœˆæ¬¡ä½œæ¥­å ±å‘Šãƒ„ãƒ¼ãƒ«</h1>
          <p>ITæ¥­å‹™ã®ä½œæ¥­å®Ÿç¸¾ã‚’è¨˜éŒ²ãƒ»é›†è¨ˆ</p>
        </div>

        <div class="nav-tabs">
          <button class="nav-tab active" onclick="switchTab('task')">
            ğŸ“ ã‚¿ã‚¹ã‚¯ç™»éŒ²
          </button>
          <button class="nav-tab" onclick="switchTab('report')">
            ğŸ“ˆ æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ
          </button>
        </div>

        <!-- ã‚¿ã‚¹ã‚¯ç™»éŒ²ç”»é¢ -->
        <div id="task-tab" class="tab-content active">
          <h2 style="margin-bottom: 20px">ã‚¿ã‚¹ã‚¯ç®¡ç†</h2>

          <div class="task-form">
            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º -->
            <div class="calendar-section">
              <div class="calendar-header">
                <button class="calendar-nav-btn" onclick="changeMonth(-1)">
                  â—€
                </button>
                <div class="calendar-title">
                  <span id="calendar-month-year"></span>
                </div>
                <button class="calendar-nav-btn" onclick="changeMonth(1)">
                  â–¶
                </button>
                <button class="calendar-today-btn" onclick="goToToday()">
                  ä»Šæ—¥
                </button>
              </div>

              <div class="calendar-weekdays">
                <div>æ—¥</div>
                <div>æœˆ</div>
                <div>ç«</div>
                <div>æ°´</div>
                <div>æœ¨</div>
                <div>é‡‘</div>
                <div>åœŸ</div>
              </div>

              <div class="calendar-grid" id="calendar-grid"></div>

              <div class="current-date-info">
                <div class="current-date">
                  <span class="date-icon">ğŸ“…</span>
                  <span id="current-date" class="date-text"></span>
                </div>
                <div class="today-stats">
                  <span>é¸æŠæ—¥ã®ä½œæ¥­æ™‚é–“: </span>
                  <span id="today-total-hours" class="stats-value">0.0h</span>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="task-name">ã‚¿ã‚¹ã‚¯åï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼‰ *</label>
              <input
                type="text"
                id="task-name"
                placeholder="ä¾‹: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™º"
                maxlength="100"
              />
            </div>

            <div class="form-group">
              <label for="category">ã‚«ãƒ†ã‚´ãƒª *</label>
              <select id="category">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="é–‹ç™º">é–‹ç™º</option>
                <option value="ä¼šè­°">ä¼šè­°</option>
                <option value="ãƒ¡ãƒ¼ãƒ«">ãƒ¡ãƒ¼ãƒ«</option>
                <option value="èª¿æŸ»">èª¿æŸ»</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
              </select>
            </div>

            <div class="form-group">
              <label for="memo">ãƒ¡ãƒ¢</label>
              <textarea
                id="memo"
                rows="3"
                placeholder="ä½œæ¥­å†…å®¹ã®è©³ç´°ãªã©..."
                maxlength="500"
              ></textarea>
            </div>

            <div class="timer-section">
              <div class="timer-display" id="timer">00:00:00</div>
              <div class="timer-buttons">
                <button
                  class="btn btn-success"
                  id="start-btn"
                  onclick="startTimer()"
                >
                  â–¶ é–‹å§‹
                </button>
                <button
                  class="btn btn-danger"
                  id="stop-btn"
                  onclick="stopTimer()"
                  disabled
                >
                  â¸ åœæ­¢
                </button>
                <button
                  class="btn btn-success"
                  id="resume-btn"
                  onclick="resumeTimer()"
                  disabled
                  style="display: none"
                >
                  â–¶ å†é–‹
                </button>
                <button
                  class="btn btn-primary"
                  id="save-btn"
                  onclick="saveTask()"
                  disabled
                >
                  ğŸ’¾ ä¿å­˜
                </button>
              </div>
            </div>
          </div>

          <div class="tasks-list">
            <h3 style="margin-bottom: 15px">é¸æŠæ—¥ã®ä½œæ¥­å±¥æ­´</h3>
            <div id="tasks-container"></div>
          </div>
        </div>

        <!-- æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”»é¢ -->
        <div id="report-tab" class="tab-content">
          <div class="report-header">
            <h2>æœˆæ¬¡ä½œæ¥­ãƒ¬ãƒãƒ¼ãƒˆ</h2>
            <div class="report-filters">
              <select id="report-year">
                <option value="2026">2026å¹´</option>
                <option value="2025">2025å¹´</option>
                <option value="2024">2024å¹´</option>
              </select>

              <select id="report-month">
                <option value="1">1æœˆ</option>
                <option value="2">2æœˆ</option>
                <option value="3">3æœˆ</option>
                <option value="4">4æœˆ</option>
                <option value="5">5æœˆ</option>
                <option value="6">6æœˆ</option>
                <option value="7">7æœˆ</option>
                <option value="8">8æœˆ</option>
                <option value="9">9æœˆ</option>
                <option value="10">10æœˆ</option>
                <option value="11">11æœˆ</option>
                <option value="12">12æœˆ</option>
              </select>

              <select id="group-by">
                <option value="category">ã‚«ãƒ†ã‚´ãƒªåˆ¥</option>
                <option value="project">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥</option>
              </select>

              <button
                class="btn btn-primary btn-small"
                onclick="generateReport()"
              >
                ğŸ” é›†è¨ˆ
              </button>
              <button class="btn btn-success btn-small" onclick="exportCSV()">
                ğŸ“¥ CSVå‡ºåŠ›
              </button>
              <button
                class="btn btn-primary btn-small"
                onclick="window.print()"
              >
                ğŸ–¨ï¸ å°åˆ·
              </button>
            </div>
          </div>

          <div class="summary-cards">
            <div class="summary-card">
              <h3>ç·ä½œæ¥­æ—¥æ•°</h3>
              <div class="value" id="total-days">-</div>
            </div>
            <div
              class="summary-card"
              style="
                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
              "
            >
              <h3>ç·ä½œæ¥­æ™‚é–“</h3>
              <div class="value" id="total-hours">-</div>
            </div>
            <div
              class="summary-card"
              style="
                background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
              "
            >
              <h3>ã‚¿ã‚¹ã‚¯ä»¶æ•°</h3>
              <div class="value" id="total-tasks">-</div>
            </div>
          </div>

          <table class="report-table">
            <thead>
              <tr>
                <th>ã‚«ãƒ†ã‚´ãƒª / ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</th>
                <th>ä½œæ¥­æ™‚é–“</th>
                <th>å‰²åˆ</th>
                <th>é€²æ—</th>
              </tr>
            </thead>
            <tbody id="report-table-body">
              <tr>
                <td
                  colspan="4"
                  style="text-align: center; padding: 40px; color: #999"
                >
                  ã€Œé›†è¨ˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
      <div id="edit-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>âœï¸ ã‚¿ã‚¹ã‚¯ç·¨é›†</h2>
            <button class="close-btn" onclick="closeEditModal()">
              &times;
            </button>
          </div>

          <div class="form-group">
            <label for="edit-task-name">ã‚¿ã‚¹ã‚¯åï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼‰ *</label>
            <input type="text" id="edit-task-name" maxlength="100" />
          </div>

          <div class="form-group">
            <label for="edit-category">ã‚«ãƒ†ã‚´ãƒª *</label>
            <select id="edit-category">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="é–‹ç™º">é–‹ç™º</option>
              <option value="ä¼šè­°">ä¼šè­°</option>
              <option value="ãƒ¡ãƒ¼ãƒ«">ãƒ¡ãƒ¼ãƒ«</option>
              <option value="èª¿æŸ»">èª¿æŸ»</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>

          <div class="form-group">
            <label for="edit-memo">ãƒ¡ãƒ¢</label>
            <textarea id="edit-memo" rows="3" maxlength="500"></textarea>
          </div>

          <div class="modal-footer">
            <button class="btn btn-primary btn-small" onclick="saveEditTask()">
              ğŸ’¾ ä¿å­˜
            </button>
            <button class="btn btn-danger btn-small" onclick="closeEditModal()">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Firebase Auth + JavaScript ===== -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        GoogleAuthProvider,
        signInWithPopup,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

      // â˜…ã‚ãªãŸã®Firebaseè¨­å®šã«å·®ã—æ›¿ãˆã¦ãã ã•ã„
      const firebaseConfig = {
        apiKey: "AIzaSyBV5NIf7e-lsyvW5ybkbgABNzK_sWRRuvI",
        authDomain: "monday-project-6fbf3.firebaseapp.com",
        projectId: "monday-project-6fbf3",
        storageBucket: "monday-project-6fbf3.firebasestorage.app",
        messagingSenderId: "930616423237",
        appId: "1:930616423237:web:93fd6fb767be3f8409442c",
        measurementId: "G-PKZ0MYLPS0",
      };

      const fbApp = initializeApp(firebaseConfig);
      const fbAuth = getAuth(fbApp);

      // èªè¨¼æ¸ˆã¿ãƒ•ã‚§ãƒƒãƒ
      async function getIdTokenOrThrow() {
        const user = fbAuth.currentUser;
        if (!user) throw new Error("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™");
        return await user.getIdToken();
      }

      async function authedFetch(url, options = {}) {
        const idToken = await getIdTokenOrThrow();
        const headers = options.headers || {};
        return fetch(url, {
          ...options,
          headers: { ...headers, Authorization: `Bearer ${idToken}` },
        });
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
      window.loginWithGoogle = async function () {
        document.getElementById("auth-error").textContent = "";
        try {
          await signInWithPopup(fbAuth, new GoogleAuthProvider());
        } catch (e) {
          document.getElementById("auth-error").textContent = e.message;
        }
      };

      window.loginWithEmail = async function () {
        document.getElementById("auth-error").textContent = "";
        try {
          const email = document.getElementById("login-email").value;
          const password = document.getElementById("login-password").value;
          await signInWithEmailAndPassword(fbAuth, email, password);
        } catch (e) {
          document.getElementById("auth-error").textContent = e.message;
        }
      };

      window.signupWithEmail = async function () {
        document.getElementById("auth-error").textContent = "";
        try {
          const email = document.getElementById("login-email").value;
          const password = document.getElementById("login-password").value;
          await createUserWithEmailAndPassword(fbAuth, email, password);
        } catch (e) {
          document.getElementById("auth-error").textContent = e.message;
        }
      };

      window.logout = async function () {
        await signOut(fbAuth);
      };

      // ===== ã‚¿ã‚¹ã‚¯ç®¡ç†JavaScript =====
      let timerInterval,
        seconds = 0,
        isRunning = false,
        isStopped = false;
      let currentTaskId = null,
        editingTaskId = null;
      let currentCalendarDate = new Date(),
        selectedDate = new Date();

      onAuthStateChanged(fbAuth, (user) => {
        const authBox = document.getElementById("auth-box");
        const appBox = document.getElementById("app-box");
        const userBox = document.getElementById("auth-user");

        if (user) {
          authBox.style.display = "none";
          appBox.style.display = "block";
          userBox.textContent = user.email || user.uid;

          selectedDate = new Date();
          renderCalendar();
          updateCurrentDate();
          loadTasksForSelectedDate();

          const now = new Date();
          document.getElementById("report-year").value = now.getFullYear();
          document.getElementById("report-month").value = now.getMonth() + 1;
        } else {
          authBox.style.display = "block";
          appBox.style.display = "none";
          userBox.textContent = "";
        }
      });

      function renderCalendar() {
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        const monthNames = [
          "1æœˆ",
          "2æœˆ",
          "3æœˆ",
          "4æœˆ",
          "5æœˆ",
          "6æœˆ",
          "7æœˆ",
          "8æœˆ",
          "9æœˆ",
          "10æœˆ",
          "11æœˆ",
          "12æœˆ",
        ];
        document.getElementById("calendar-month-year").textContent =
          `${year}å¹´ ${monthNames[month]}`;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const firstDayOfWeek = firstDay.getDay();
        const daysInMonth = lastDay.getDate();

        const calendarGrid = document.getElementById("calendar-grid");
        calendarGrid.innerHTML = "";

        const prevMonthLastDay = new Date(year, month, 0).getDate();
        for (let i = firstDayOfWeek - 1; i >= 0; i--) {
          const dayDiv = document.createElement("div");
          dayDiv.className = "calendar-day other-month";
          dayDiv.textContent = prevMonthLastDay - i;
          calendarGrid.appendChild(dayDiv);
        }

        const today = new Date();
        const isCurrentMonth =
          today.getFullYear() === year && today.getMonth() === month;

        for (let day = 1; day <= daysInMonth; day++) {
          const dayDiv = document.createElement("div");
          dayDiv.className = "calendar-day";
          dayDiv.textContent = day;

          const currentDate = new Date(year, month, day);

          if (isCurrentMonth && today.getDate() === day)
            dayDiv.classList.add("today");
          if (
            selectedDate.getFullYear() === year &&
            selectedDate.getMonth() === month &&
            selectedDate.getDate() === day
          )
            dayDiv.classList.add("selected");

          if (currentDate > today) {
            dayDiv.classList.add("future");
          } else {
            dayDiv.onclick = () => selectDate(year, month, day);
          }

          calendarGrid.appendChild(dayDiv);
        }

        const totalCells = firstDayOfWeek + daysInMonth;
        const rows = Math.ceil(totalCells / 7);
        const cellsToFill = rows * 7 - totalCells;
        for (let day = 1; day <= cellsToFill; day++) {
          const dayDiv = document.createElement("div");
          dayDiv.className = "calendar-day other-month";
          dayDiv.textContent = day;
          calendarGrid.appendChild(dayDiv);
        }
      }

      function selectDate(year, month, day) {
        selectedDate = new Date(year, month, day);
        renderCalendar();
        updateCurrentDate();
        loadTasksForSelectedDate();
      }

      window.changeMonth = function (delta) {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
        renderCalendar();
      };

      window.goToToday = function () {
        const today = new Date();
        currentCalendarDate = new Date(today);
        selectedDate = new Date(today);
        renderCalendar();
        updateCurrentDate();
        loadTasksForSelectedDate();
      };

      function updateCurrentDate() {
        const options = {
          year: "numeric",
          month: "long",
          day: "numeric",
          weekday: "long",
        };
        document.getElementById("current-date").textContent =
          selectedDate.toLocaleDateString("ja-JP", options);
      }

      function updateTodayTotalHours(tasks) {
        const totalSeconds = (tasks || []).reduce(
          (sum, task) => sum + (task.duration_seconds || 0),
          0,
        );
        document.getElementById("today-total-hours").textContent =
          `${(totalSeconds / 3600).toFixed(1)}h`;
      }

      async function loadTasksForSelectedDate() {
        const container = document.getElementById("tasks-container");
        container.innerHTML =
          '<p style="text-align:center;color:#666;padding:20px;">èª­ã¿è¾¼ã¿ä¸­...</p>';

        try {
          const dateStr = selectedDate.toISOString().split("T")[0];
          const response = await authedFetch(`/api/tasks/date?date=${dateStr}`);
          if (!response.ok) throw new Error("ã‚¿ã‚¹ã‚¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");

          const data = await response.json();
          displayTasks(data.tasks || []);
          updateTodayTotalHours(data.tasks || []);
        } catch (error) {
          console.error("ã‚¿ã‚¹ã‚¯å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
          container.innerHTML = `<p style="text-align:center;color:#d00;padding:20px;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
        }
      }

      function displayTasks(tasks) {
        const container = document.getElementById("tasks-container");
        if (!tasks || tasks.length === 0) {
          container.innerHTML =
            '<p style="text-align:center;color:#999;padding:40px;">ã“ã®æ—¥ã¯ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>';
          return;
        }

        container.innerHTML = tasks
          .map((task) => {
            const totalSeconds = task.duration_seconds || 0;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const secs = totalSeconds % 60;

            let timeText =
              hours > 0
                ? `${hours}æ™‚é–“${minutes}åˆ†${secs}ç§’`
                : minutes > 0
                  ? `${minutes}åˆ†${secs}ç§’`
                  : `${secs}ç§’`;

            const startTime = task.start_time
              ? new Date(task.start_time).toLocaleTimeString("ja-JP")
              : "-";
            const endTime = task.end_time
              ? new Date(task.end_time).toLocaleTimeString("ja-JP")
              : "-";

            return `
          <div class="task-item">
            <div class="task-info">
              <div class="task-name">${escapeHtml(task.task_name)}</div>
              <div class="task-meta">
                <span class="task-badge badge-category">ğŸ“ ${escapeHtml(task.category)}</span>
                <span class="task-badge badge-time">â± ${timeText}</span>
                <span class="task-badge badge-start">ğŸ• é–‹å§‹: ${startTime}</span>
                <span class="task-badge badge-end">ğŸ•‘ çµ‚äº†: ${endTime}</span>
              </div>
              ${task.memo ? `<div style="color:#666;font-size:14px;margin-top:10px;padding-top:10px;border-top:1px solid #f0f0f0;">ğŸ“ ${escapeHtml(task.memo)}</div>` : ""}
            </div>
            <div class="task-actions">
              <button class="btn btn-warning btn-small" onclick="openEditModal('${task.id}')">âœï¸ ç·¨é›†</button>
              <button class="btn btn-danger btn-small" onclick="deleteTask('${task.id}')">ğŸ—‘ å‰Šé™¤</button>
            </div>
          </div>`;
          })
          .join("");
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text ?? "";
        return div.innerHTML;
      }

      window.switchTab = function (tab) {
        document
          .querySelectorAll(".nav-tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));

        if (tab === "task") {
          document
            .querySelector(".nav-tab:first-child")
            .classList.add("active");
          document.getElementById("task-tab").classList.add("active");
        } else {
          document.querySelector(".nav-tab:last-child").classList.add("active");
          document.getElementById("report-tab").classList.add("active");
        }
      };

      window.startTimer = async function () {
        if (isRunning) return;

        const taskName = document.getElementById("task-name").value;
        const category = document.getElementById("category").value;
        const memo = document.getElementById("memo").value;

        if (!taskName || !category) {
          alert("ã‚¿ã‚¹ã‚¯åã¨ã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰é–‹å§‹ã—ã¦ãã ã•ã„");
          return;
        }

        try {
          const dateStr = selectedDate.toISOString().split("T")[0];
          const response = await authedFetch("/api/task/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              task_name: taskName,
              category,
              memo,
              created_date: dateStr,
            }),
          });

          if (!response.ok) throw new Error("ã‚¿ã‚¹ã‚¯ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");

          const data = await response.json();
          currentTaskId = data.task.id;

          const startResponse = await authedFetch("/api/task/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ task_id: currentTaskId }),
          });

          if (!startResponse.ok) throw new Error("ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ");

          isRunning = true;
          isStopped = false;
          document.getElementById("start-btn").disabled = true;
          document.getElementById("stop-btn").disabled = false;
          document.getElementById("save-btn").disabled = true;
          document.getElementById("timer").classList.remove("stopped");

          timerInterval = setInterval(() => {
            seconds++;
            updateTimerDisplay();
          }, 1000);
        } catch (error) {
          console.error("ã‚¨ãƒ©ãƒ¼:", error);
          alert("é–‹å§‹ã«å¤±æ•—: " + error.message);
        }
      };

      window.stopTimer = async function () {
        if (!isRunning || !currentTaskId) return;

        isRunning = false;
        isStopped = true;
        clearInterval(timerInterval);

        document.getElementById("timer").classList.add("stopped");
        document.getElementById("start-btn").disabled = true;
        document.getElementById("stop-btn").disabled = true;
        document.getElementById("stop-btn").style.display = "none";
        document.getElementById("resume-btn").disabled = false;
        document.getElementById("resume-btn").style.display = "inline-block";
        document.getElementById("save-btn").disabled = false;
      };

      window.resumeTimer = function () {
        if (isRunning || !isStopped || !currentTaskId) return;

        isRunning = true;
        isStopped = false;

        document.getElementById("timer").classList.remove("stopped");
        document.getElementById("start-btn").disabled = true;
        document.getElementById("resume-btn").disabled = true;
        document.getElementById("resume-btn").style.display = "none";
        document.getElementById("stop-btn").disabled = false;
        document.getElementById("stop-btn").style.display = "inline-block";
        document.getElementById("save-btn").disabled = true;

        timerInterval = setInterval(() => {
          seconds++;
          updateTimerDisplay();
        }, 1000);
      };

      function updateTimerDisplay() {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        document.getElementById("timer").textContent =
          `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(secs).padStart(2, "0")}`;
      }

      window.saveTask = async function () {
        if (!currentTaskId) {
          alert("ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„");
          return;
        }

        try {
          const response = await authedFetch("/api/task/stop", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ task_id: currentTaskId }),
          });

          if (!response.ok) throw new Error("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");

          await loadTasksForSelectedDate();

          document.getElementById("task-name").value = "";
          document.getElementById("category").value = "";
          document.getElementById("memo").value = "";
          seconds = 0;
          updateTimerDisplay();

          currentTaskId = null;
          isStopped = false;
          isRunning = false;

          document.getElementById("start-btn").disabled = false;
          document.getElementById("stop-btn").disabled = true;
          document.getElementById("stop-btn").style.display = "inline-block";
          document.getElementById("resume-btn").disabled = true;
          document.getElementById("resume-btn").style.display = "none";
          document.getElementById("save-btn").disabled = true;
          document.getElementById("timer").classList.remove("stopped");

          if (timerInterval) clearInterval(timerInterval);

          alert("ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
        } catch (error) {
          console.error("ã‚¨ãƒ©ãƒ¼:", error);
          alert("ä¿å­˜ã«å¤±æ•—: " + error.message);
        }
      };

      window.openEditModal = async function (taskId) {
        editingTaskId = taskId;

        try {
          const dateStr = selectedDate.toISOString().split("T")[0];
          const response = await authedFetch(`/api/tasks/date?date=${dateStr}`);
          if (!response.ok) throw new Error("ã‚¿ã‚¹ã‚¯æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");

          const data = await response.json();
          const task = (data.tasks || []).find((t) => t.id === taskId);

          if (!task) {
            alert("ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            return;
          }

          document.getElementById("edit-task-name").value = task.task_name;
          document.getElementById("edit-category").value = task.category;
          document.getElementById("edit-memo").value = task.memo || "";

          document.getElementById("edit-modal").classList.add("active");
        } catch (error) {
          console.error("ã‚¨ãƒ©ãƒ¼:", error);
          alert("å–å¾—ã«å¤±æ•—: " + error.message);
        }
      };

      window.closeEditModal = function () {
        document.getElementById("edit-modal").classList.remove("active");
        editingTaskId = null;
      };

      window.saveEditTask = async function () {
        if (!editingTaskId) return;

        const taskName = document.getElementById("edit-task-name").value;
        const category = document.getElementById("edit-category").value;
        const memo = document.getElementById("edit-memo").value;

        if (!taskName || !category) {
          alert("ã‚¿ã‚¹ã‚¯åã¨ã‚«ãƒ†ã‚´ãƒªã¯å¿…é ˆã§ã™");
          return;
        }

        try {
          const response = await authedFetch(
            `/api/task/update/${editingTaskId}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ task_name: taskName, category, memo }),
            },
          );

          if (!response.ok) throw new Error("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");

          closeEditModal();
          await loadTasksForSelectedDate();
          alert("æ›´æ–°ã—ã¾ã—ãŸï¼");
        } catch (error) {
          console.error("ã‚¨ãƒ©ãƒ¼:", error);
          alert("æ›´æ–°ã«å¤±æ•—: " + error.message);
        }
      };

      window.deleteTask = async function (taskId) {
        if (!confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

        try {
          const response = await authedFetch(`/api/task/delete/${taskId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });

          if (!response.ok) throw new Error("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");

          await loadTasksForSelectedDate();
          alert("å‰Šé™¤ã—ã¾ã—ãŸ");
        } catch (error) {
          console.error("ã‚¨ãƒ©ãƒ¼:", error);
          alert("å‰Šé™¤ã«å¤±æ•—: " + error.message);
        }
      };

      window.generateReport = async function () {
        const year = document.getElementById("report-year").value;
        const month = document.getElementById("report-month").value;
        const groupBy = document.getElementById("group-by").value;

        try {
          const response = await authedFetch(
            `/api/report/monthly?year=${year}&month=${month}&group_by=${groupBy}`,
          );
          if (!response.ok) throw new Error("ãƒ¬ãƒãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");

          const data = await response.json();

          document.getElementById("total-days").textContent =
            `${data.totals?.total_days ?? 0}æ—¥`;
          document.getElementById("total-hours").textContent =
            `${(data.totals?.total_hours ?? 0).toFixed(1)}h`;
          document.getElementById("total-tasks").textContent =
            `${data.totals?.total_tasks ?? 0}ä»¶`;

          displayReportTable(data.data || []);
        } catch (error) {
          console.error("ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
          alert("ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—: " + error.message);
        }
      };

      function displayReportTable(data) {
        const tbody = document.getElementById("report-table-body");

        if (!data || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:40px;color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`;
          return;
        }

        const sumSeconds =
          data.reduce((sum, d) => sum + (d.total_seconds || 0), 0) || 1;

        tbody.innerHTML = data
          .map((item) => {
            const hours = (item.total_hours || 0).toFixed(1);
            const percentage = (
              ((item.total_seconds || 0) / sumSeconds) *
              100
            ).toFixed(1);

            return `
          <tr>
            <td>${escapeHtml(item.name)}</td>
            <td>${hours}æ™‚é–“</td>
            <td>${percentage}%</td>
            <td>
              <div class="progress-bar">
                <div class="progress-fill" style="width:${percentage}%"></div>
              </div>
            </td>
          </tr>`;
          })
          .join("");
      }

      window.exportCSV = async function () {
        const year = document.getElementById("report-year").value;
        const month = document.getElementById("report-month").value;

        try {
          const response = await authedFetch(
            `/api/export/csv?year=${year}&month=${month}`,
          );
          if (!response.ok) throw new Error("CSVå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ");

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `tasks_${year}_${String(month).padStart(2, "0")}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ");
        } catch (error) {
          console.error("CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:", error);
          alert("CSVå‡ºåŠ›ã«å¤±æ•—: " + error.message);
        }
      };

      window.onclick = function (event) {
        const modal = document.getElementById("edit-modal");
        if (event.target === modal) closeEditModal();
      };
    </script>
  </body>
</html>
