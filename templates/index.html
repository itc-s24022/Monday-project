<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æœˆæ¬¡ä½œæ¥­å ±å‘Šãƒ„ãƒ¼ãƒ«</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .nav-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        background: white;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .nav-tab {
        flex: 1;
        padding: 15px 20px;
        background: #f5f5f5;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s;
      }

      .nav-tab:hover {
        background: #e0e0e0;
      }

      .nav-tab.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .tab-content {
        display: none;
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
      .calendar-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      }

      .current-date {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .date-icon {
        font-size: 28px;
      }

      .date-text {
        font-size: 22px;
      }

      .today-stats {
        font-size: 18px;
        opacity: 0.95;
        margin-top: 8px;
      }

      .stats-value {
        font-weight: bold;
        font-size: 20px;
        color: #ffd700;
      }

      /* ã‚¿ã‚¹ã‚¯ç™»éŒ²ç”»é¢ */
      .task-form {
        background: #f9f9f9;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 30px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .timer-section {
        text-align: center;
        margin: 30px 0;
      }

      .timer-display {
        font-size: 4em;
        font-weight: bold;
        color: #667eea;
        margin: 20px 0;
        font-variant-numeric: tabular-nums;
      }

      .timer-display.stopped {
        color: #999;
      }

      .timer-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .btn {
        padding: 15px 40px;
        border: none;
        border-radius: 50px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
      }

      .btn-success:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(56, 239, 125, 0.4);
      }

      .btn-danger {
        background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        color: white;
      }

      .btn-danger:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(238, 9, 121, 0.4);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* ã‚¿ã‚¹ã‚¯ä¸€è¦§ */
      .tasks-list {
        margin-top: 30px;
      }

      .task-item {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s;
      }

      .task-item:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      }

      .task-info {
        flex: 1;
      }

      .task-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
      }

      .task-meta {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .task-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 13px;
        font-weight: 500;
      }

      .badge-category {
        background: #e3f2fd;
        color: #1976d2;
      }

      .badge-time {
        background: #f3e5f5;
        color: #7b1fa2;
      }

      .badge-start {
        background: #fff3e0;
        color: #e65100;
      }

      .badge-end {
        background: #fce4ec;
        color: #c2185b;
      }

      .badge-duration {
        background: #e8eaf6;
        color: #3f51b5;
      }

      .task-actions {
        display: flex;
        gap: 10px;
      }

      .btn-small {
        padding: 8px 16px;
        font-size: 14px;
        border-radius: 6px;
      }

      /* ãƒ¬ãƒãƒ¼ãƒˆç”»é¢ */
      .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
      }

      .report-filters {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .report-filters select {
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
      }

      .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
      }

      .summary-card h3 {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .summary-card .value {
        font-size: 2.5em;
        font-weight: bold;
      }

      .report-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .report-table th {
        background: #f5f5f5;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #e0e0e0;
      }

      .report-table td {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
      }

      .report-table tr:hover {
        background: #f9f9f9;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s;
      }

      /* å°åˆ·ç”¨CSS */
      @media print {
        body {
          background: white;
          padding: 0;
        }

        .nav-tabs,
        .timer-section,
        .task-actions,
        .btn,
        .calendar-section {
          display: none !important;
        }

        .container {
          max-width: 100%;
        }

        .tab-content {
          box-shadow: none;
          padding: 20px;
        }

        .report-table {
          page-break-inside: avoid;
        }
      }

      /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
      @media (max-width: 768px) {
        .header h1 {
          font-size: 1.8em;
        }

        .timer-display {
          font-size: 3em;
        }

        .task-item {
          flex-direction: column;
          align-items: flex-start;
        }

        .task-actions {
          margin-top: 15px;
          width: 100%;
        }

        .task-actions button {
          flex: 1;
        }

        .task-meta {
          gap: 8px;
        }

        .task-badge {
          font-size: 12px;
          padding: 5px 10px;
        }

        .current-date {
          font-size: 20px;
        }

        .date-text {
          font-size: 18px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ“Š æœˆæ¬¡ä½œæ¥­å ±å‘Šãƒ„ãƒ¼ãƒ«</h1>
        <p>ITæ¥­å‹™ã®ä½œæ¥­å®Ÿç¸¾ã‚’è¨˜éŒ²ãƒ»é›†è¨ˆ</p>
      </div>

      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('task')">
          ğŸ“ ã‚¿ã‚¹ã‚¯ç™»éŒ²
        </button>
        <button class="nav-tab" onclick="switchTab('report')">
          ğŸ“ˆ æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ
        </button>
      </div>

      <!-- ã‚¿ã‚¹ã‚¯ç™»éŒ²ç”»é¢ -->
      <div id="task-tab" class="tab-content active">
        <h2 style="margin-bottom: 20px">æœ¬æ—¥ã®ã‚¿ã‚¹ã‚¯</h2>

        <div class="task-form">
          <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º -->
          <div class="calendar-section">
            <div class="current-date">
              <span class="date-icon">ğŸ“…</span>
              <span id="current-date" class="date-text"></span>
            </div>
            <div class="today-stats">
              <span>æœ¬æ—¥ã®ä½œæ¥­æ™‚é–“: </span>
              <span id="today-total-hours" class="stats-value">0.0h</span>
            </div>
          </div>

          <div class="form-group">
            <label for="task-name">ã‚¿ã‚¹ã‚¯åï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼‰ *</label>
            <input
              type="text"
              id="task-name"
              placeholder="ä¾‹: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™º"
              maxlength="100"
            />
          </div>

          <div class="form-group">
            <label for="category">ã‚«ãƒ†ã‚´ãƒª *</label>
            <select id="category">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="é–‹ç™º">é–‹ç™º</option>
              <option value="ä¼šè­°">ä¼šè­°</option>
              <option value="ãƒ¡ãƒ¼ãƒ«">ãƒ¡ãƒ¼ãƒ«</option>
              <option value="èª¿æŸ»">èª¿æŸ»</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>

          <div class="form-group">
            <label for="memo">ãƒ¡ãƒ¢</label>
            <textarea
              id="memo"
              rows="3"
              placeholder="ä½œæ¥­å†…å®¹ã®è©³ç´°ãªã©..."
              maxlength="500"
            ></textarea>
          </div>

          <div class="timer-section">
            <div class="timer-display" id="timer">00:00:00</div>
            <div class="timer-buttons">
              <button
                class="btn btn-success"
                id="start-btn"
                onclick="startTimer()"
              >
                â–¶ é–‹å§‹
              </button>
              <button
                class="btn btn-danger"
                id="stop-btn"
                onclick="stopTimer()"
                disabled
              >
                â¸ åœæ­¢
              </button>
              <button
                class="btn btn-success"
                id="resume-btn"
                onclick="resumeTimer()"
                disabled
                style="display: none"
              >
                â–¶ å†é–‹
              </button>
              <button
                class="btn btn-primary"
                id="save-btn"
                onclick="saveTask()"
                disabled
              >
                ğŸ’¾ ä¿å­˜
              </button>
            </div>
          </div>
        </div>

        <div class="tasks-list">
          <h3 style="margin-bottom: 15px">ä»Šæ—¥ã®ä½œæ¥­å±¥æ­´</h3>
          <div id="tasks-container">
            <!-- ã‚¿ã‚¹ã‚¯ã¯JavaScriptã§å‹•çš„ã«è¡¨ç¤º -->
          </div>
        </div>
      </div>

      <!-- æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”»é¢ -->
      <div id="report-tab" class="tab-content">
        <div class="report-header">
          <h2>æœˆæ¬¡ä½œæ¥­ãƒ¬ãƒãƒ¼ãƒˆ</h2>
          <div class="report-filters">
            <select id="report-year">
              <option value="2026">2026å¹´</option>
              <option value="2025">2025å¹´</option>
              <option value="2024">2024å¹´</option>
            </select>
            <select id="report-month">
              <option value="1">1æœˆ</option>
              <option value="2">2æœˆ</option>
              <option value="3">3æœˆ</option>
              <option value="4">4æœˆ</option>
              <option value="5">5æœˆ</option>
              <option value="6">6æœˆ</option>
              <option value="7">7æœˆ</option>
              <option value="8">8æœˆ</option>
              <option value="9">9æœˆ</option>
              <option value="10">10æœˆ</option>
              <option value="11">11æœˆ</option>
              <option value="12">12æœˆ</option>
            </select>
            <select id="group-by">
              <option value="category">ã‚«ãƒ†ã‚´ãƒªåˆ¥</option>
              <option value="project">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥</option>
            </select>
            <button
              class="btn btn-primary btn-small"
              onclick="generateReport()"
            >
              ğŸ” é›†è¨ˆ
            </button>
            <button class="btn btn-success btn-small" onclick="exportCSV()">
              ğŸ“¥ CSVå‡ºåŠ›
            </button>
            <button class="btn btn-primary btn-small" onclick="window.print()">
              ğŸ–¨ï¸ å°åˆ·
            </button>
          </div>
        </div>

        <div class="summary-cards">
          <div class="summary-card">
            <h3>ç·ä½œæ¥­æ—¥æ•°</h3>
            <div class="value" id="total-days">-</div>
          </div>
          <div
            class="summary-card"
            style="
              background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            "
          >
            <h3>ç·ä½œæ¥­æ™‚é–“</h3>
            <div class="value" id="total-hours">-</div>
          </div>
          <div
            class="summary-card"
            style="
              background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            "
          >
            <h3>ã‚¿ã‚¹ã‚¯ä»¶æ•°</h3>
            <div class="value" id="total-tasks">-</div>
          </div>
        </div>

        <table class="report-table">
          <thead>
            <tr>
              <th>ã‚«ãƒ†ã‚´ãƒª / ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</th>
              <th>ä½œæ¥­æ™‚é–“</th>
              <th>å‰²åˆ</th>
              <th>é€²æ—</th>
            </tr>
          </thead>
          <tbody id="report-table-body">
            <tr>
              <td
                colspan="4"
                style="text-align: center; padding: 40px; color: #999"
              >
                ã€Œé›†è¨ˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      let timerInterval;
      let seconds = 0;
      let isRunning = false;
      let isStopped = false; // åœæ­¢çŠ¶æ…‹ã‚’è¿½è·¡
      let currentTaskId = null;

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
      document.addEventListener("DOMContentLoaded", function () {
        console.log("ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†");

        // ç¾åœ¨ã®æ—¥ä»˜ã‚’è¡¨ç¤º
        updateCurrentDate();

        // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        loadTodayTasks();

        // ç¾åœ¨ã®å¹´æœˆã‚’è¨­å®š
        const now = new Date();
        document.getElementById("report-year").value = now.getFullYear();
        document.getElementById("report-month").value = now.getMonth() + 1;
      });

      // ç¾åœ¨ã®æ—¥ä»˜ã‚’è¡¨ç¤º
      function updateCurrentDate() {
        const now = new Date();
        const options = {
          year: "numeric",
          month: "long",
          day: "numeric",
          weekday: "long",
        };
        const dateStr = now.toLocaleDateString("ja-JP", options);
        document.getElementById("current-date").textContent = dateStr;
      }

      // ä»Šæ—¥ã®ç·ä½œæ¥­æ™‚é–“ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
      function updateTodayTotalHours(tasks) {
        if (!tasks || tasks.length === 0) {
          document.getElementById("today-total-hours").textContent = "0.0h";
          return;
        }

        const totalSeconds = tasks.reduce((sum, task) => {
          return sum + (task.duration_seconds || 0);
        }, 0);

        const totalHours = (totalSeconds / 3600).toFixed(1);
        document.getElementById(
          "today-total-hours"
        ).textContent = `${totalHours}h`;
      }

      // ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
      async function loadTodayTasks() {
        console.log("ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿é–‹å§‹...");
        const container = document.getElementById("tasks-container");
        container.innerHTML =
          '<p style="text-align: center; color: #666; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</p>';

        try {
          const response = await fetch("/api/tasks/today");
          console.log("APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:", response);

          if (!response.ok) {
            console.error("APIã‚¨ãƒ©ãƒ¼:", response.status, response.statusText);
            container.innerHTML =
              '<p style="text-align: center; color: #ff0000; padding: 20px;">ã‚¨ãƒ©ãƒ¼: APIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚app.pyã« /api/tasks/today ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
            return;
          }

          const data = await response.json();
          console.log("å–å¾—ãƒ‡ãƒ¼ã‚¿:", data);
          const tasks = data.tasks || [];

          // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’è¡¨ç¤º
          displayTasks(tasks);

          // æœ¬æ—¥ã®ç·ä½œæ¥­æ™‚é–“ã‚’æ›´æ–°
          updateTodayTotalHours(tasks);
        } catch (error) {
          console.error("ã‚¿ã‚¹ã‚¯å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
          container.innerHTML = `<p style="text-align: center; color: #ff0000; padding: 20px;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
        }
      }

      // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’è¡¨ç¤º
      function displayTasks(tasks) {
        console.log("ã‚¿ã‚¹ã‚¯è¡¨ç¤º:", tasks.length, "ä»¶");
        const container = document.getElementById("tasks-container");

        if (!tasks || tasks.length === 0) {
          container.innerHTML =
            '<p style="text-align: center; color: #999; padding: 40px;">ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>';
          return;
        }

        container.innerHTML = tasks
          .map((task) => {
            // ä½œæ¥­æ™‚é–“ã®è¨ˆç®—
            const totalSeconds = task.duration_seconds || 0;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const secs = totalSeconds % 60;

            let timeText = "";
            if (hours > 0) {
              timeText = `${hours}æ™‚é–“${minutes}åˆ†${secs}ç§’`;
            } else if (minutes > 0) {
              timeText = `${minutes}åˆ†${secs}ç§’`;
            } else {
              timeText = `${secs}ç§’`;
            }

            // é–‹å§‹æ™‚åˆ»ãƒ»çµ‚äº†æ™‚åˆ»ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const startTime = task.start_time
              ? new Date(task.start_time).toLocaleString("ja-JP", {
                  hour: "2-digit",
                  minute: "2-digit",
                  second: "2-digit",
                })
              : "-";
            const endTime = task.end_time
              ? new Date(task.end_time).toLocaleString("ja-JP", {
                  hour: "2-digit",
                  minute: "2-digit",
                  second: "2-digit",
                })
              : "-";

            return `
                    <div class="task-item">
                        <div class="task-info">
                            <div class="task-name">${escapeHtml(
                              task.task_name
                            )}</div>
                            <div class="task-meta">
                                <span class="task-badge badge-category">ğŸ“ ${escapeHtml(
                                  task.category
                                )}</span>
                                <span class="task-badge badge-time">â± ${timeText}</span>
                                <span class="task-badge badge-start">ğŸ• é–‹å§‹: ${startTime}</span>
                                <span class="task-badge badge-end">ğŸ•‘ çµ‚äº†: ${endTime}</span>
                            </div>
                            ${
                              task.memo
                                ? `<div style="color: #666; font-size: 14px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0;">ğŸ“ ${escapeHtml(
                                    task.memo
                                  )}</div>`
                                : ""
                            }
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-danger btn-small" onclick="deleteTask(${
                              task.id
                            })">ğŸ—‘ å‰Šé™¤</button>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function switchTab(tab) {
        document
          .querySelectorAll(".nav-tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));

        if (tab === "task") {
          document
            .querySelector(".nav-tab:first-child")
            .classList.add("active");
          document.getElementById("task-tab").classList.add("active");
        } else {
          document.querySelector(".nav-tab:last-child").classList.add("active");
          document.getElementById("report-tab").classList.add("active");
        }
      }

      async function startTimer() {
        if (isRunning) return;

        const taskName = document.getElementById("task-name").value;
        const category = document.getElementById("category").value;
        const memo = document.getElementById("memo").value;

        if (!taskName || !category) {
          alert("ã‚¿ã‚¹ã‚¯åã¨ã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰é–‹å§‹ã—ã¦ãã ã•ã„");
          return;
        }

        // ã‚¿ã‚¹ã‚¯ã‚’ç™»éŒ²
        try {
          const response = await fetch("/api/task/add", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              task_name: taskName,
              category: category,
              memo: memo,
            }),
          });

          if (!response.ok) {
            throw new Error("ã‚¿ã‚¹ã‚¯ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          const data = await response.json();
          currentTaskId = data.task.id;

          // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹APIã‚’å‘¼ã¶
          const startResponse = await fetch("/api/task/start", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              task_id: currentTaskId,
            }),
          });

          if (!startResponse.ok) {
            throw new Error("ã‚¿ã‚¤ãƒãƒ¼ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          isRunning = true;
          isStopped = false;
          document.getElementById("start-btn").disabled = true;
          document.getElementById("stop-btn").disabled = false;
          document.getElementById("save-btn").disabled = true;

          // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’é€šå¸¸ã®è‰²ã«æˆ»ã™
          document.getElementById("timer").classList.remove("stopped");

          timerInterval = setInterval(() => {
            seconds++;
            updateTimerDisplay();
          }, 1000);
        } catch (error) {
          console.error("ã‚¨ãƒ©ãƒ¼:", error);
          alert("ã‚¿ã‚¹ã‚¯ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      async function stopTimer() {
        if (!isRunning || !currentTaskId) return;

        // ã‚¿ã‚¤ãƒãƒ¼ã‚’ä¸€æ™‚åœæ­¢ï¼ˆAPIã¯å‘¼ã°ãªã„ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§åœæ­¢ï¼‰
        isRunning = false;
        isStopped = true;
        clearInterval(timerInterval);

        // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
        document.getElementById("timer").classList.add("stopped");

        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        document.getElementById("start-btn").disabled = true;
        document.getElementById("stop-btn").disabled = true;
        document.getElementById("stop-btn").style.display = "none";
        document.getElementById("resume-btn").disabled = false;
        document.getElementById("resume-btn").style.display = "inline-block";
        document.getElementById("save-btn").disabled = false;
      }

      function resumeTimer() {
        if (isRunning || !isStopped || !currentTaskId) return;

        // ã‚¿ã‚¤ãƒãƒ¼ã‚’å†é–‹
        isRunning = true;
        isStopped = false;

        // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’é€šå¸¸ã®è‰²ã«æˆ»ã™
        document.getElementById("timer").classList.remove("stopped");

        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        document.getElementById("start-btn").disabled = true;
        document.getElementById("resume-btn").disabled = true;
        document.getElementById("resume-btn").style.display = "none";
        document.getElementById("stop-btn").disabled = false;
        document.getElementById("stop-btn").style.display = "inline-block";
        document.getElementById("save-btn").disabled = true;

        timerInterval = setInterval(() => {
          seconds++;
          updateTimerDisplay();
        }, 1000);
      }

      function updateTimerDisplay() {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        document.getElementById("timer").textContent = `${String(
          hours
        ).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(
          secs
        ).padStart(2, "0")}`;
      }

      async function saveTask() {
        if (!currentTaskId) {
          alert("ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„");
          return;
        }

        try {
          // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢APIã‚’å‘¼ã¶
          const response = await fetch("/api/task/stop", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              task_id: currentTaskId,
            }),
          });

          if (!response.ok) {
            throw new Error("ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
          await loadTodayTasks();

          // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
          document.getElementById("task-name").value = "";
          document.getElementById("category").value = "";
          document.getElementById("memo").value = "";
          seconds = 0;
          updateTimerDisplay();
          currentTaskId = null;
          isStopped = false;
          isRunning = false;

          // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
          document.getElementById("start-btn").disabled = false;
          document.getElementById("stop-btn").disabled = true;
          document.getElementById("stop-btn").style.display = "inline-block";
          document.getElementById("resume-btn").disabled = true;
          document.getElementById("resume-btn").style.display = "none";
          document.getElementById("save-btn").disabled = true;

          // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’é€šå¸¸ã®è‰²ã«æˆ»ã™
          document.getElementById("timer").classList.remove("stopped");

          // ã‚¿ã‚¤ãƒãƒ¼ãŒå‹•ã„ã¦ã„ã‚‹å ´åˆã¯åœæ­¢
          if (timerInterval) {
            clearInterval(timerInterval);
          }

          alert("ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
        } catch (error) {
          console.error("ã‚¨ãƒ©ãƒ¼:", error);
          alert("ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      async function deleteTask(id) {
        if (!confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
          return;
        }

        try {
          const response = await fetch(`/api/task/delete/${id}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            throw new Error("ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
          loadTodayTasks();
          alert("ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
        } catch (error) {
          console.error("ã‚¨ãƒ©ãƒ¼:", error);
          alert("ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      async function generateReport() {
        const year = document.getElementById("report-year").value;
        const month = document.getElementById("report-month").value;
        const groupBy = document.getElementById("group-by").value;

        console.log(`ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ: ${year}å¹´${month}æœˆ (${groupBy})`);

        try {
          const response = await fetch(
            `/api/report/monthly?year=${year}&month=${month}&group_by=${groupBy}`
          );

          if (!response.ok) {
            throw new Error("ãƒ¬ãƒãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          const data = await response.json();
          console.log("ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿:", data);

          // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
          const totalDays = data.totals?.total_days || 0;
          const totalHours = data.totals?.total_hours || 0;
          const totalTasks = data.totals?.total_tasks || 0;

          document.getElementById("total-days").textContent = `${totalDays}æ—¥`;
          document.getElementById("total-hours").textContent = `${totalHours}h`;
          document.getElementById(
            "total-tasks"
          ).textContent = `${totalTasks}ä»¶`;

          // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
          displayReportTable(data.data || []);
        } catch (error) {
          console.error("ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
          alert("ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      function displayReportTable(data) {
        const tbody = document.getElementById("report-table-body");

        if (!data || data.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: #999;">
                            ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                        </td>
                    </tr>
                `;
          return;
        }

        tbody.innerHTML = data
          .map((item) => {
            const hours = item.total_hours || 0;
            const percentage = (
              ((item.total_seconds || 0) /
                data.reduce((sum, d) => sum + (d.total_seconds || 0), 0)) *
              100
            ).toFixed(1);

            return `
                    <tr>
                        <td>${escapeHtml(item.name)}</td>
                        <td>${hours}æ™‚é–“</td>
                        <td>${percentage}%</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
          })
          .join("");
      }

      async function exportCSV() {
        const year = document.getElementById("report-year").value;
        const month = document.getElementById("report-month").value;

        try {
          const response = await fetch(
            `/api/export/csv?year=${year}&month=${month}`
          );

          if (!response.ok) {
            throw new Error("CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `tasks_${year}_${month.padStart(2, "0")}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ");
        } catch (error) {
          console.error("CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:", error);
          alert("CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }
    </script>
  </body>
</html>
