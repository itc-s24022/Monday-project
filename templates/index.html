<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æœˆæ¬¡ä½œæ¥­å ±å‘Šãƒ„ãƒ¼ãƒ«</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ“Š æœˆæ¬¡ä½œæ¥­å ±å‘Šãƒ„ãƒ¼ãƒ«</h1>
        <p>ITæ¥­å‹™ã®ä½œæ¥­å®Ÿç¸¾ã‚’è¨˜éŒ²ãƒ»é›†è¨ˆ</p>
      </div>

      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('task')">
          ğŸ“ ã‚¿ã‚¹ã‚¯ç™»éŒ²
        </button>
        <button class="nav-tab" onclick="switchTab('report')">
          ğŸ“ˆ æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ
        </button>
      </div>

      <!-- ã‚¿ã‚¹ã‚¯ç™»éŒ²ç”»é¢ -->
      <div id="task-tab" class="tab-content active">
        <h2 style="margin-bottom: 20px">ã‚¿ã‚¹ã‚¯ç®¡ç†</h2>

        <div class="task-form">
          <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º -->
          <div class="calendar-section">
            <div class="calendar-header">
              <button class="calendar-nav-btn" onclick="changeMonth(-1)">
                â—€
              </button>
              <div class="calendar-title">
                <span id="calendar-month-year"></span>
              </div>
              <button class="calendar-nav-btn" onclick="changeMonth(1)">
                â–¶
              </button>
              <button class="calendar-today-btn" onclick="goToToday()">
                ä»Šæ—¥
              </button>
            </div>
            <div class="calendar-weekdays">
              <div>æ—¥</div>
              <div>æœˆ</div>
              <div>ç«</div>
              <div>æ°´</div>
              <div>æœ¨</div>
              <div>é‡‘</div>
              <div>åœŸ</div>
            </div>
            <div class="calendar-grid" id="calendar-grid">
              <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            <div class="current-date-info">
              <div class="current-date">
                <span class="date-icon">ğŸ“…</span>
                <span id="current-date" class="date-text"></span>
              </div>
              <div class="today-stats">
                <span>é¸æŠæ—¥ã®ä½œæ¥­æ™‚é–“: </span>
                <span id="today-total-hours" class="stats-value">0.0h</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="task-name">ã‚¿ã‚¹ã‚¯åï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼‰ *</label>
            <input
              type="text"
              id="task-name"
              placeholder="ä¾‹: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™º"
              maxlength="100"
            />
          </div>

          <div class="form-group">
            <label for="category">ã‚«ãƒ†ã‚´ãƒª *</label>
            <select id="category">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="é–‹ç™º">é–‹ç™º</option>
              <option value="ä¼šè­°">ä¼šè­°</option>
              <option value="ãƒ¡ãƒ¼ãƒ«">ãƒ¡ãƒ¼ãƒ«</option>
              <option value="èª¿æŸ»">èª¿æŸ»</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>

          <div class="form-group">
            <label for="memo">ãƒ¡ãƒ¢</label>
            <textarea
              id="memo"
              rows="3"
              placeholder="ä½œæ¥­å†…å®¹ã®è©³ç´°ãªã©..."
              maxlength="500"
            ></textarea>
          </div>

          <div class="timer-section">
            <div class="timer-display" id="timer">00:00:00</div>
            <div class="timer-buttons">
              <button
                class="btn btn-success"
                id="start-btn"
                onclick="startTimer()"
              >
                â–¶ é–‹å§‹
              </button>
              <button
                class="btn btn-danger"
                id="stop-btn"
                onclick="stopTimer()"
                disabled
              >
                â¸ åœæ­¢
              </button>
              <button
                class="btn btn-success"
                id="resume-btn"
                onclick="resumeTimer()"
                disabled
                style="display: none"
              >
                â–¶ å†é–‹
              </button>
              <button
                class="btn btn-primary"
                id="save-btn"
                onclick="saveTask()"
                disabled
              >
                ğŸ’¾ ä¿å­˜
              </button>
            </div>
          </div>
        </div>

        <div class="tasks-list">
          <h3 style="margin-bottom: 15px">é¸æŠæ—¥ã®ä½œæ¥­å±¥æ­´</h3>
          <div id="tasks-container">
            <!-- ã‚¿ã‚¹ã‚¯ã¯JavaScriptã§å‹•çš„ã«è¡¨ç¤º -->
          </div>
        </div>
      </div>

      <!-- æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”»é¢ -->
      <div id="report-tab" class="tab-content">
        <div class="report-header">
          <h2>æœˆæ¬¡ä½œæ¥­ãƒ¬ãƒãƒ¼ãƒˆ</h2>
          <div class="report-filters">
            <select id="report-year">
              <option value="2026">2026å¹´</option>
              <option value="2025">2025å¹´</option>
              <option value="2024">2024å¹´</option>
            </select>
            <select id="report-month">
              <option value="1">1æœˆ</option>
              <option value="2">2æœˆ</option>
              <option value="3">3æœˆ</option>
              <option value="4">4æœˆ</option>
              <option value="5">5æœˆ</option>
              <option value="6">6æœˆ</option>
              <option value="7">7æœˆ</option>
              <option value="8">8æœˆ</option>
              <option value="9">9æœˆ</option>
              <option value="10">10æœˆ</option>
              <option value="11">11æœˆ</option>
              <option value="12">12æœˆ</option>
            </select>
            <select id="group-by">
              <option value="category">ã‚«ãƒ†ã‚´ãƒªåˆ¥</option>
              <option value="project">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥</option>
            </select>
            <button
              class="btn btn-primary btn-small"
              onclick="generateReport()"
            >
              ğŸ” é›†è¨ˆ
            </button>
            <button class="btn btn-success btn-small" onclick="exportCSV()">
              ğŸ“¥ CSVå‡ºåŠ›
            </button>
            <button class="btn btn-primary btn-small" onclick="window.print()">
              ğŸ–¨ï¸ å°åˆ·
            </button>
          </div>
        </div>

        <div class="summary-cards">
          <div class="summary-card">
            <h3>ç·ä½œæ¥­æ—¥æ•°</h3>
            <div class="value" id="total-days">-</div>
          </div>
          <div
            class="summary-card"
            style="
              background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            "
          >
            <h3>ç·ä½œæ¥­æ™‚é–“</h3>
            <div class="value" id="total-hours">-</div>
          </div>
          <div
            class="summary-card"
            style="
              background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            "
          >
            <h3>ã‚¿ã‚¹ã‚¯ä»¶æ•°</h3>
            <div class="value" id="total-tasks">-</div>
          </div>
        </div>

        <table class="report-table">
          <thead>
            <tr>
              <th>ã‚«ãƒ†ã‚´ãƒª / ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</th>
              <th>ä½œæ¥­æ™‚é–“</th>
              <th>å‰²åˆ</th>
              <th>é€²æ—</th>
            </tr>
          </thead>
          <tbody id="report-table-body">
            <tr>
              <td
                colspan="4"
                style="text-align: center; padding: 40px; color: #999"
              >
                ã€Œé›†è¨ˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>âœï¸ ã‚¿ã‚¹ã‚¯ç·¨é›†</h2>
          <button class="close-btn" onclick="closeEditModal()">&times;</button>
        </div>

        <div class="form-group">
          <label for="edit-task-name">ã‚¿ã‚¹ã‚¯åï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼‰ *</label>
          <input
            type="text"
            id="edit-task-name"
            placeholder="ä¾‹: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™º"
            maxlength="100"
          />
        </div>

        <div class="form-group">
          <label for="edit-category">ã‚«ãƒ†ã‚´ãƒª *</label>
          <select id="edit-category">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="é–‹ç™º">é–‹ç™º</option>
            <option value="ä¼šè­°">ä¼šè­°</option>
            <option value="ãƒ¡ãƒ¼ãƒ«">ãƒ¡ãƒ¼ãƒ«</option>
            <option value="èª¿æŸ»">èª¿æŸ»</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>

        <div class="form-group">
          <label for="edit-memo">ãƒ¡ãƒ¢</label>
          <textarea
            id="edit-memo"
            rows="3"
            placeholder="ä½œæ¥­å†…å®¹ã®è©³ç´°ãªã©..."
            maxlength="500"
          ></textarea>
        </div>

        <div class="modal-footer">
          <button class="btn btn-primary btn-small" onclick="saveEditTask()">
            ğŸ’¾ ä¿å­˜
          </button>
          <button class="btn btn-danger btn-small" onclick="closeEditModal()">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
        </div>
      </div>
    </div>

    <script>
      let timerInterval;
      let seconds = 0;
      let isRunning = false;
      let isStopped = false;
      let currentTaskId = null;
      let editingTaskId = null;

      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢é€£ã®å¤‰æ•°
      let currentCalendarDate = new Date();
      let selectedDate = new Date();

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
      document.addEventListener("DOMContentLoaded", function () {
        selectedDate = new Date(); // ä»Šæ—¥ã®æ—¥ä»˜ã‚’é¸æŠçŠ¶æ…‹ã«
        renderCalendar();
        updateCurrentDate();
        loadTasksForSelectedDate();
        const now = new Date();
        document.getElementById("report-year").value = now.getFullYear();
        document.getElementById("report-month").value = now.getMonth() + 1;
      });

      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»é–¢æ•°
      function renderCalendar() {
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();

        // æœˆãƒ»å¹´ã®è¡¨ç¤º
        const monthNames = [
          "1æœˆ",
          "2æœˆ",
          "3æœˆ",
          "4æœˆ",
          "5æœˆ",
          "6æœˆ",
          "7æœˆ",
          "8æœˆ",
          "9æœˆ",
          "10æœˆ",
          "11æœˆ",
          "12æœˆ",
        ];
        document.getElementById(
          "calendar-month-year"
        ).textContent = `${year}å¹´ ${monthNames[month]}`;

        // æœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥ã‚’å–å¾—
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const firstDayOfWeek = firstDay.getDay(); // 0 = æ—¥æ›œæ—¥
        const daysInMonth = lastDay.getDate();

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢
        const calendarGrid = document.getElementById("calendar-grid");
        calendarGrid.innerHTML = "";

        // å‰æœˆã®æ—¥ä»˜ã§åŸ‹ã‚ã‚‹
        const prevMonthLastDay = new Date(year, month, 0).getDate();
        for (let i = firstDayOfWeek - 1; i >= 0; i--) {
          const dayDiv = document.createElement("div");
          dayDiv.className = "calendar-day other-month";
          dayDiv.textContent = prevMonthLastDay - i;
          calendarGrid.appendChild(dayDiv);
        }

        // ä»Šæ—¥ã®æ—¥ä»˜
        const today = new Date();
        const isCurrentMonth =
          today.getFullYear() === year && today.getMonth() === month;

        // å½“æœˆã®æ—¥ä»˜
        for (let day = 1; day <= daysInMonth; day++) {
          const dayDiv = document.createElement("div");
          dayDiv.className = "calendar-day";
          dayDiv.textContent = day;

          const currentDate = new Date(year, month, day);

          // ä»Šæ—¥ã®æ—¥ä»˜ã«ãƒãƒ¼ã‚¯
          if (isCurrentMonth && today.getDate() === day) {
            dayDiv.classList.add("today");
          }

          // é¸æŠä¸­ã®æ—¥ä»˜ã«ãƒãƒ¼ã‚¯
          if (
            selectedDate.getFullYear() === year &&
            selectedDate.getMonth() === month &&
            selectedDate.getDate() === day
          ) {
            dayDiv.classList.add("selected");
          }

          // æœªæ¥ã®æ—¥ä»˜ã‚’ç„¡åŠ¹åŒ–
          if (currentDate > today) {
            dayDiv.classList.add("future");
          } else {
            dayDiv.onclick = () => selectDate(year, month, day);
          }

          calendarGrid.appendChild(dayDiv);
        }

        // æ¬¡æœˆã®æ—¥ä»˜ã§åŸ‹ã‚ã‚‹
        const totalCells = firstDayOfWeek + daysInMonth;
        const rows = Math.ceil(totalCells / 7);
        const cellsToFill = rows * 7 - totalCells;
        for (let day = 1; day <= cellsToFill; day++) {
          const dayDiv = document.createElement("div");
          dayDiv.className = "calendar-day other-month";
          dayDiv.textContent = day;
          calendarGrid.appendChild(dayDiv);
        }
      }

      // æ—¥ä»˜é¸æŠ
      function selectDate(year, month, day) {
        selectedDate = new Date(year, month, day);
        renderCalendar();
        updateCurrentDate();
        loadTasksForSelectedDate();
      }

      // æœˆã‚’å¤‰æ›´
      function changeMonth(delta) {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
        renderCalendar();
      }

      // ä»Šæ—¥ã«æˆ»ã‚‹
      function goToToday() {
        const today = new Date();
        currentCalendarDate = new Date(today);
        selectedDate = new Date(today);
        renderCalendar();
        updateCurrentDate();
        loadTasksForSelectedDate();
      }

      function updateCurrentDate() {
        const options = {
          year: "numeric",
          month: "long",
          day: "numeric",
          weekday: "long",
        };
        const dateStr = selectedDate.toLocaleDateString("ja-JP", options);
        document.getElementById("current-date").textContent = dateStr;
      }

      function updateTodayTotalHours(tasks) {
        if (!tasks || tasks.length === 0) {
          document.getElementById("today-total-hours").textContent = "0.0h";
          return;
        }

        const totalSeconds = tasks.reduce((sum, task) => {
          return sum + (task.duration_seconds || 0);
        }, 0);

        const totalHours = (totalSeconds / 3600).toFixed(1);
        document.getElementById(
          "today-total-hours"
        ).textContent = `${totalHours}h`;
      }

      async function loadTasksForSelectedDate() {
        const container = document.getElementById("tasks-container");
        container.innerHTML =
          '<p style="text-align: center; color: #666; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</p>';

        try {
          // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã®YYYY-MM-DDå½¢å¼ã®æ–‡å­—åˆ—ã‚’ä½œæˆ
          const dateStr = selectedDate.toISOString().split("T")[0];

          const response = await fetch(`/api/tasks/date?date=${dateStr}`);

          if (!response.ok) {
            // 404ã®å ´åˆã¯ã‚¿ã‚¹ã‚¯ãŒãªã„ã ã‘ãªã®ã§ã€ç©ºé…åˆ—ã¨ã—ã¦å‡¦ç†
            if (response.status === 404) {
              displayTasks([]);
              updateTodayTotalHours([]);
              return;
            }
            container.innerHTML =
              '<p style="text-align: center; color: #ff0000; padding: 20px;">ã‚¨ãƒ©ãƒ¼: ã‚¿ã‚¹ã‚¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            return;
          }

          const data = await response.json();
          const tasks = data.tasks || [];
          displayTasks(tasks);
          updateTodayTotalHours(tasks);
        } catch (error) {
          console.error("ã‚¿ã‚¹ã‚¯å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
          container.innerHTML = `<p style="text-align: center; color: #ff0000; padding: 20px;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
        }
      }

      // ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
      async function loadTodayTasks() {
        await loadTasksForSelectedDate();
      }

      function displayTasks(tasks) {
        const container = document.getElementById("tasks-container");

        if (!tasks || tasks.length === 0) {
          container.innerHTML =
            '<p style="text-align: center; color: #999; padding: 40px;">ã“ã®æ—¥ã¯ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>';
          return;
        }

        container.innerHTML = tasks
          .map((task) => {
            const totalSeconds = task.duration_seconds || 0;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const secs = totalSeconds % 60;

            let timeText = "";
            if (hours > 0) {
              timeText = `${hours}æ™‚é–“${minutes}åˆ†${secs}ç§’`;
            } else if (minutes > 0) {
              timeText = `${minutes}åˆ†${secs}ç§’`;
            } else {
              timeText = `${secs}ç§’`;
            }

            const startTime = task.start_time
              ? new Date(task.start_time).toLocaleString("ja-JP", {
                  hour: "2-digit",
                  minute: "2-digit",
                  second: "2-digit",
                })
              : "-";
            const endTime = task.end_time
              ? new Date(task.end_time).toLocaleString("ja-JP", {
                  hour: "2-digit",
                  minute: "2-digit",
                  second: "2-digit",
                })
              : "-";

            return `
                    <div class="task-item">
                        <div class="task-info">
                            <div class="task-name">${escapeHtml(
                              task.task_name
                            )}</div>
                            <div class="task-meta">
                                <span class="task-badge badge-category">ğŸ“ ${escapeHtml(
                                  task.category
                                )}</span>
                                <span class="task-badge badge-time">â± ${timeText}</span>
                                <span class="task-badge badge-start">ğŸ• é–‹å§‹: ${startTime}</span>
                                <span class="task-badge badge-end">ğŸ•‘ çµ‚äº†: ${endTime}</span>
                            </div>
                            ${
                              task.memo
                                ? `<div style="color: #666; font-size: 14px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0;">ğŸ“ ${escapeHtml(
                                    task.memo
                                  )}</div>`
                                : ""
                            }
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-warning btn-small" onclick="openEditModal(${
                              task.id
                            })">âœï¸ ç·¨é›†</button>
                            <button class="btn btn-danger btn-small" onclick="deleteTask(${
                              task.id
                            })">ğŸ—‘ å‰Šé™¤</button>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function switchTab(tab) {
        document
          .querySelectorAll(".nav-tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));

        if (tab === "task") {
          document
            .querySelector(".nav-tab:first-child")
            .classList.add("active");
          document.getElementById("task-tab").classList.add("active");
        } else {
          document.querySelector(".nav-tab:last-child").classList.add("active");
          document.getElementById("report-tab").classList.add("active");
        }
      }

      async function startTimer() {
        if (isRunning) return;

        const taskName = document.getElementById("task-name").value;
        const category = document.getElementById("category").value;
        const memo = document.getElementById("memo").value;

        if (!taskName || !category) {
          alert("ã‚¿ã‚¹ã‚¯åã¨ã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰é–‹å§‹ã—ã¦ãã ã•ã„");
          return;
        }

        try {
          // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã‚’ISOå½¢å¼ã§é€ä¿¡
          const dateStr = selectedDate.toISOString().split("T")[0];

          const response = await fetch("/api/task/add", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              task_name: taskName,
              category: category,
              memo: memo,
              created_date: dateStr,
            }),
          });

          if (!response.ok) {
            throw new Error("ã‚¿ã‚¹ã‚¯ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          const data = await response.json();
          currentTaskId = data.task.id;

          const startResponse = await fetch("/api/task/start", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              task_id: currentTaskId,
            }),
          });

          if (!startResponse.ok) {
            throw new Error("ã‚¿ã‚¤ãƒãƒ¼ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          isRunning = true;
          isStopped = false;
          document.getElementById("start-btn").disabled = true;
          document.getElementById("stop-btn").disabled = false;
          document.getElementById("save-btn").disabled = true;
          document.getElementById("timer").classList.remove("stopped");

          timerInterval = setInterval(() => {
            seconds++;
            updateTimerDisplay();
          }, 1000);
        } catch (error) {
          console.error("ã‚¨ãƒ©ãƒ¼:", error);
          alert("ã‚¿ã‚¹ã‚¯ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      async function stopTimer() {
        if (!isRunning || !currentTaskId) return;

        isRunning = false;
        isStopped = true;
        clearInterval(timerInterval);

        document.getElementById("timer").classList.add("stopped");
        document.getElementById("start-btn").disabled = true;
        document.getElementById("stop-btn").disabled = true;
        document.getElementById("stop-btn").style.display = "none";
        document.getElementById("resume-btn").disabled = false;
        document.getElementById("resume-btn").style.display = "inline-block";
        document.getElementById("save-btn").disabled = false;
      }

      function resumeTimer() {
        if (isRunning || !isStopped || !currentTaskId) return;

        isRunning = true;
        isStopped = false;

        document.getElementById("timer").classList.remove("stopped");
        document.getElementById("start-btn").disabled = true;
        document.getElementById("resume-btn").disabled = true;
        document.getElementById("resume-btn").style.display = "none";
        document.getElementById("stop-btn").disabled = false;
        document.getElementById("stop-btn").style.display = "inline-block";
        document.getElementById("save-btn").disabled = true;

        timerInterval = setInterval(() => {
          seconds++;
          updateTimerDisplay();
        }, 1000);
      }

      function updateTimerDisplay() {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        document.getElementById("timer").textContent = `${String(
          hours
        ).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(
          secs
        ).padStart(2, "0")}`;
      }

      async function saveTask() {
        if (!currentTaskId) {
          alert("ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„");
          return;
        }

        try {
          const response = await fetch("/api/task/stop", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              task_id: currentTaskId,
            }),
          });

          if (!response.ok) {
            throw new Error("ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          await loadTasksForSelectedDate();

          document.getElementById("task-name").value = "";
          document.getElementById("category").value = "";
          document.getElementById("memo").value = "";
          seconds = 0;
          updateTimerDisplay();
          currentTaskId = null;
          isStopped = false;
          isRunning = false;

          document.getElementById("start-btn").disabled = false;
          document.getElementById("stop-btn").disabled = true;
          document.getElementById("stop-btn").style.display = "inline-block";
          document.getElementById("resume-btn").disabled = true;
          document.getElementById("resume-btn").style.display = "none";
          document.getElementById("save-btn").disabled = true;
          document.getElementById("timer").classList.remove("stopped");

          if (timerInterval) {
            clearInterval(timerInterval);
          }

          alert("ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
        } catch (error) {
          console.error("ã‚¨ãƒ©ãƒ¼:", error);
          alert("ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      async function openEditModal(taskId) {
        editingTaskId = taskId;

        try {
          const dateStr = selectedDate.toISOString().split("T")[0];
          const response = await fetch(`/api/tasks/date?date=${dateStr}`);
          if (!response.ok) throw new Error("ã‚¿ã‚¹ã‚¯æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");

          const data = await response.json();
          const task = data.tasks.find((t) => t.id === taskId);

          if (!task) {
            alert("ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            return;
          }

          document.getElementById("edit-task-name").value = task.task_name;
          document.getElementById("edit-category").value = task.category;
          document.getElementById("edit-memo").value = task.memo || "";

          document.getElementById("edit-modal").classList.add("active");
        } catch (error) {
          console.error("ã‚¨ãƒ©ãƒ¼:", error);
          alert("ã‚¿ã‚¹ã‚¯æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      function closeEditModal() {
        document.getElementById("edit-modal").classList.remove("active");
        editingTaskId = null;
      }

      async function saveEditTask() {
        if (!editingTaskId) return;

        const taskName = document.getElementById("edit-task-name").value;
        const category = document.getElementById("edit-category").value;
        const memo = document.getElementById("edit-memo").value;

        if (!taskName || !category) {
          alert("ã‚¿ã‚¹ã‚¯åã¨ã‚«ãƒ†ã‚´ãƒªã¯å¿…é ˆã§ã™");
          return;
        }

        try {
          const response = await fetch(`/api/task/update/${editingTaskId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              task_name: taskName,
              category: category,
              memo: memo,
            }),
          });

          if (!response.ok) {
            throw new Error("ã‚¿ã‚¹ã‚¯ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          closeEditModal();
          await loadTasksForSelectedDate();
          alert("ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
        } catch (error) {
          console.error("ã‚¨ãƒ©ãƒ¼:", error);
          alert("ã‚¿ã‚¹ã‚¯ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      async function deleteTask(id) {
        if (!confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
          return;
        }

        try {
          const response = await fetch(`/api/task/delete/${id}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            throw new Error("ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          loadTasksForSelectedDate();
          alert("ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
        } catch (error) {
          console.error("ã‚¨ãƒ©ãƒ¼:", error);
          alert("ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      async function generateReport() {
        const year = document.getElementById("report-year").value;
        const month = document.getElementById("report-month").value;
        const groupBy = document.getElementById("group-by").value;

        try {
          const response = await fetch(
            `/api/report/monthly?year=${year}&month=${month}&group_by=${groupBy}`
          );

          if (!response.ok) {
            throw new Error("ãƒ¬ãƒãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          const data = await response.json();

          const totalDays = data.totals?.total_days || 0;
          const totalHours = data.totals?.total_hours || 0;
          const totalTasks = data.totals?.total_tasks || 0;

          document.getElementById("total-days").textContent = `${totalDays}æ—¥`;
          document.getElementById("total-hours").textContent = `${totalHours}h`;
          document.getElementById(
            "total-tasks"
          ).textContent = `${totalTasks}ä»¶`;

          displayReportTable(data.data || []);
        } catch (error) {
          console.error("ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
          alert("ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      function displayReportTable(data) {
        const tbody = document.getElementById("report-table-body");

        if (!data || data.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: #999;">
                            ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                        </td>
                    </tr>
                `;
          return;
        }

        tbody.innerHTML = data
          .map((item) => {
            const hours = item.total_hours || 0;
            const percentage = (
              ((item.total_seconds || 0) /
                data.reduce((sum, d) => sum + (d.total_seconds || 0), 0)) *
              100
            ).toFixed(1);

            return `
                    <tr>
                        <td>${escapeHtml(item.name)}</td>
                        <td>${hours}æ™‚é–“</td>
                        <td>${percentage}%</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
          })
          .join("");
      }

      async function exportCSV() {
        const year = document.getElementById("report-year").value;
        const month = document.getElementById("report-month").value;

        try {
          const response = await fetch(
            `/api/export/csv?year=${year}&month=${month}`
          );

          if (!response.ok) {
            throw new Error("CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `tasks_${year}_${month.padStart(2, "0")}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ");
        } catch (error) {
          console.error("CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:", error);
          alert("CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      window.onclick = function (event) {
        const modal = document.getElementById("edit-modal");
        if (event.target === modal) {
          closeEditModal();
        }
      };
    </script>
  </body>
</html>
